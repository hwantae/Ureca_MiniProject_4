<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤í„°ë””ë£¸ ì˜ˆì•½</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; color: #333; margin-top: 10px; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-board {
      padding: 8px 15px;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .btn-board:hover { background-color: #545b62; }

    /* âœ… ë‚´ ì˜ˆì•½ ë²„íŠ¼(ì´ˆë¡ìƒ‰) */
    .btn-my {
      padding: 8px 15px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-my:hover { opacity: 0.9; }

    .top-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .top-controls input[type="date"] { padding: 6px 10px; }

    .room-list { display: flex; flex-wrap: wrap; gap: 15px; }
    .room-card {
      background: #fff; border: 1px solid #ddd; padding: 20px; width: 200px;
      cursor: pointer; border-radius: 8px; transition: transform 0.2s; position: relative;
    }
    .room-card:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    .room-name { font-size: 1.3em; font-weight: bold; margin-bottom: 10px; }
    .available { color: green; }
    .unavailable { color: red; }

    .badge {
      position: absolute; top: 10px; right: 10px;
      background: #3498db; color: #fff; padding: 4px 8px;
      border-radius: 999px; font-size: 12px;
    }
  </style>
</head>
<body>

<div class="header">
  <button class="btn-board" onclick="location.href='board.html'">â† ê²Œì‹œíŒìœ¼ë¡œ</button>

  <div class="top-controls">
    <button class="btn-my" onclick="location.href='my_reservation.html'">ë‚´ ì˜ˆì•½</button>
    <span id="user-greeting" style="font-weight: bold; color: #555;"></span>
    <span>ğŸ“…</span>
    <input type="date" id="datePicker">
  </div>
</div>

<h1>ìŠ¤í„°ë””ë£¸ ì˜ˆì•½</h1>

<div id="rooms" class="room-list">
  <div class="loading">ë¡œë”© ì¤‘...</div>
</div>

<script>
  function getToken() { return sessionStorage.getItem('authToken'); }

  async function loadUserInfo() {
    try {
      const authToken = getToken();
      if (!authToken) {
        document.getElementById('user-greeting').innerHTML = '<a href="/login">ë¡œê·¸ì¸ í•„ìš”</a>';
        return;
      }
      const res = await fetch('/users/info', { headers: { 'X-AUTH-TOKEN': authToken } });
      if (res.ok) {
        const user = await res.json();
        document.getElementById('user-greeting').textContent = `ì•ˆë…•í•˜ì„¸ìš” ${user.name}ë‹˜`;
      } else {
        document.getElementById('user-greeting').innerHTML = '<a href="/login">ë¡œê·¸ì¸ í•„ìš”</a>';
      }
    } catch (e) {
      console.error('User info load failed', e);
    }
  }

  async function fetchReservedCount(roomId, date, authToken) {
    try {
      const res = await fetch(`/api/reservations/rooms/${roomId}?date=${date}`, {
        headers: { 'X-AUTH-TOKEN': authToken }
      });
      if (!res.ok) return 0;
      const list = await res.json();
      return (list || []).length;
    } catch (e) {
      return 0;
    }
  }

  async function loadRooms(date) {
    const authToken = getToken();
    if (!authToken) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.location.href = '/login';
      return;
    }

    try {
      const res = await fetch("/api/rooms", { headers: { 'X-AUTH-TOKEN': authToken } });
      const rooms = await res.json();

      if (!rooms || rooms.length === 0) {
        document.getElementById('rooms').innerHTML = '<p>ë“±ë¡ëœ ë£¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const counts = await Promise.all(
        rooms.map(r => fetchReservedCount(r.roomId, date, authToken))
      );

      document.getElementById('rooms').innerHTML = rooms.map((r, idx) => `
        <div class="room-card" onclick="location.href='room.html?name=' + encodeURIComponent('${r.name}')">
          <div class="badge">ì˜ˆì•½ ${counts[idx]}ê±´</div>
          <div class="room-name">${r.name}</div>
          <div>ìˆ˜ìš©: ${r.capacity}ëª…</div>
          <div class="${r.isAvailable ? 'available' : 'unavailable'}">
            ${r.isAvailable ? 'â— ì´ìš© ê°€ëŠ¥' : 'â— ì´ìš© ë¶ˆê°€'}
          </div>
        </div>
      `).join('');

    } catch (e) {
      console.error(e);
      document.getElementById('rooms').innerHTML = '<p>ì˜¤ë¥˜ ë°œìƒ</p>';
    }
  }

  (function init() {
    loadUserInfo();

    const datePicker = document.getElementById('datePicker');
    datePicker.value = new Date().toISOString().split('T')[0];
    datePicker.addEventListener('change', () => loadRooms(datePicker.value));

    loadRooms(datePicker.value);
  })();
</script>
</body>
</html>
