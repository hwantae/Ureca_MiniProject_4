<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ë£¸ ê´€ë¦¬</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #fff0f0; }
        h1 { color: #333; }
        .header { margin-bottom: 20px; }
        .slots { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .slot { padding: 15px 20px; border: 1px solid #ddd; background: #fff; cursor: pointer; text-align: center; }
        .slot:hover { background: #e0e0e0; }
        .slot.unavailable { border-color: red; background: #fee; opacity: 0.8; }
        .slot.unavailable:hover { background: #fcc; }
        .slot.available { border-color: green; }
        .slot.available:hover { background: #ddd; }
        .legend { margin-top: 20px; font-size: 0.9em; color: #666; }
        .legend span { margin-right: 15px; }
    </style>
</head>

<body>
<div class="header"><a href="admin_rooms.html">â† ê´€ë¦¬ì ëª©ë¡ìœ¼ë¡œ</a></div>
<h1 id="title">ë£¸ ê´€ë¦¬ (ë¸”ë¡ ì„¤ì •)</h1>

<div style="margin:20px 0;">ğŸ“… ë‚ ì§œ: <input type="date" id="date"></div>
<div id="slots" class="slots">ë¡œë”© ì¤‘...</div>

<div class="legend">
    <span>â¬œ ì´ìš© ê°€ëŠ¥ (í´ë¦­í•˜ì—¬ ì°¨ë‹¨)</span>
    <span>ğŸŸ¥ ì°¨ë‹¨ë¨/ì‚¬ìš©ì¤‘ (í´ë¦­í•˜ì—¬ í•´ì œ)</span>
</div>

<script>
    const roomName = new URLSearchParams(location.search).get('name') || '';
    if (!roomName) location.href = 'admin_rooms.html';
    document.getElementById('title').textContent = `${roomName} ê´€ë¦¬`;

    const dateInput = document.getElementById('date');
    dateInput.value = new Date().toISOString().split('T')[0];
    dateInput.addEventListener('change', () => loadSlots(dateInput.value));

    let roomId = null;
    let currentBlocks = new Map(); // time -> blockId
    
    function formatHHmm(timeStr) {
        // "09:00:00" â†’ "09:00"
        return timeStr.substring(0, 5);
    }
    
    function hhmm(s) {
        // "09:00:00" or "09:00" -> "09:00"
        return (s || "").substring(0, 5);
    }

    function toMinutes(hhmmStr) {
        const [h, m] = hhmmStr.split(':').map(Number);
        return h * 60 + m;
    }

    function fromMinutes(min) {
        const h = String(Math.floor(min / 60)).padStart(2, '0');
        const m = String(min % 60).padStart(2, '0');
        return `${h}:${m}`;
    }

    async function loadSlots(date) {
        const container = document.getElementById('slots');
        try {
            // 1) í…œí”Œë¦¿ ìŠ¬ë¡¯ ì „ì²´ ì¡°íšŒ
            const slotsRes = await fetch(`/api/rooms/name/${encodeURIComponent(roomName)}/slots`);
            const slots = await slotsRes.json();
            if (!slots || slots.length === 0) {
                container.innerHTML = 'ìš´ì˜ ì‹œê°„ ë¯¸ì„¤ì •';
                return;
            }

            // âœ… (ì¤‘ìš”) ìš´ì˜ì‹œê°„ ë²”ìœ„ë¥¼ slots[0]ìœ¼ë¡œ ì¡ì§€ ë§ê³  min/maxë¡œ ê³„ì‚°
            // roomIdëŠ” ë™ì¼í•˜ë¯€ë¡œ ì•„ë¬´ê±°ë‚˜ í•˜ë‚˜ì—ì„œ ê°€ì ¸ì™€ë„ ë¨
            roomId = slots[0].roomId;

            const minStart = Math.min(...slots.map(s => toMinutes(hhmm(s.startTime))));
            const maxEnd   = Math.max(...slots.map(s => toMinutes(hhmm(s.endTime))));

            // 2) ë¸”ë¡ ì¡°íšŒ
            const blocksRes = await fetch(`/api/rooms/${roomId}/blocks?date=${date}`);
            const blocks = await blocksRes.json();
            currentBlocks.clear();
            blocks.forEach(b => currentBlocks.set(hhmm(b.startTime), b.id));

            // 3) ë Œë”ë§ (1ì‹œê°„ ë‹¨ìœ„)
            let html = '';
            for (let t = minStart; t < maxEnd; t += 60) {
                const time = fromMinutes(t);        // "HH:mm"
                const endTime = fromMinutes(t + 60); // "HH:mm"

                const isBlocked = currentBlocks.has(time);
                const cls = isBlocked ? 'unavailable' : 'available';

                html += `
                  <div class="slot ${cls}" onclick="toggleBlock('${time}', ${isBlocked})">
                    ${time} ~ ${endTime}
                  </div>
                `;
            }
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨';
        }
    }

    async function toggleBlock(time, isBlocked) {
        if (isBlocked) {
            if (!confirm(`${time} ë¸”ë¡ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const blockId = currentBlocks.get(time);
            await fetch(`/api/rooms/${roomId}/blocks/${blockId}`, { method: 'DELETE' });
        } else {
            if (!confirm(`${time}ì„ ë§‰ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const startMin = toMinutes(time);
            const endMin = startMin + 60;
            const endTime = fromMinutes(endMin);

            await fetch(`/api/rooms/${roomId}/blocks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ blockDate: dateInput.value, startTime: time, endTime: endTime })
            });
        }
        loadSlots(dateInput.value);
    }

    loadSlots(dateInput.value);
</script>
</body>
</html>
