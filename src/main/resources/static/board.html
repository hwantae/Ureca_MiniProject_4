<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyRoom - 게시판</title>
    <style>
        /* --- 기본 리셋 및 스타일 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: none; /* 로딩 전 숨김 */
        }

        /* --- 네비게이션 바 --- */
        nav {
            background-color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .nav-brand {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            text-decoration: none;
        }
        #btnLogout {
            background-color: transparent;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #btnLogout:hover {
            background-color: #e74c3c;
            color: white;
        }

        /* --- 메인 컨테이너 --- */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .page-title {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            display: inline-block;
        }

        /* --- 게시판 테이블 --- */
        .board-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
            table-layout: fixed; /* 고정 레이아웃 */
        }
        .board-table th, .board-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .board-table th {
            background-color: #f8f9fa;
            color: #555;
            font-weight: 600;
        }
        /* 요약 행 (클릭 가능) */
        .summary-row:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        /* --- 아코디언 상세 영역 스타일 --- */
        .detail-row {
            display: none; /* 기본 숨김 */
            background-color: #fafafa;
        }
        .detail-cell {
            padding: 0 !important; /* 내부 패딩 제거 */
            border-bottom: 1px solid #ccc;
        }
        .detail-content-box {
            padding: 20px;
            border-left: 4px solid #3498db; /* 포인트 컬러 */
            margin: 10px 20px;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .detail-text {
            white-space: pre-wrap; /* 줄바꿈 유지 */
            line-height: 1.6;
            color: #444;
            min-height: 100px;
        }
        .detail-actions {
            margin-top: 20px;
            text-align: right;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: #999;
        }

        /* --- 버튼 스타일 --- */
        .board-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .board-actions button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            transition: opacity 0.3s;
        }
        .board-actions button:hover { opacity: 0.9; }

        .btn-reservation { background-color: #007bff; }
        .btn-manage { background-color: #6c757d; }
        .btn-write { background-color: #28a745; }

        /* 수정/삭제 버튼 */
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
            margin-left: 5px;
            border-radius: 3px;
            border: none;
            color: white;
            cursor: pointer;
        }
        .btn-edit { background-color: #17a2b8; }
        .btn-delete { background-color: #dc3545; }

    </style>
</head>
<body>

<nav>
    <a href="/" class="nav-brand">StudyRoom</a>
    <button id="btnLogout">로그아웃</button>
</nav>

<div class="container">
    <h2 class="page-title">공지사항 및 게시판</h2>
    <table class="board-table">
        <colgroup>
            <col style="width: 10%">
            <col style="width: 50%">
            <col style="width: 20%">
            <col style="width: 20%">
        </colgroup>
        <thead>
        <tr>
            <th>No</th>
            <th>제목</th>
            <th>작성자</th>
            <th>작성일</th>
        </tr>
        </thead>
        <tbody id="boardList">
        </tbody>
    </table>
</div>

<div class="board-actions">
    <button type="button" class="btn-reservation" onclick="location.href='rooms.html'">
        예약하기
    </button>
    <button type="button" class="btn-manage" id="btnManage" style="display:none;" onclick="location.href='admin_rooms.html'">
        룸 관리
    </button>
    <button type="button" class="btn-write" id="btnWrite" style="display:none;" onclick="location.href='board_write.html'">
        글쓰기
    </button>
</div>

<script src="/assets/js/common.js"></script>
<script>
    let isAdmin = false;
    // 사용자 식별을 위한 변수 (이메일 등) - 로그인 시 저장했다고 가정
    const myEmail = sessionStorage.getItem('userEmail');

    window.onload = function(){
        checkAdminRole();
        getBoardData();
        document.querySelector("#btnLogout").onclick = handleLogout;
    }

    // 1. 권한 체크
    function checkAdminRole() {
        const rolesStr = sessionStorage.getItem('roles');
        if (rolesStr) {
            try {
                const roles = JSON.parse(rolesStr);
                // 중복 접두사 이슈 포함하여 체크
                if (roles.includes('ROLE_ADMIN') || roles.includes('ROLE_ROLE_ADMIN')) {
                    isAdmin = true;
                    // 관리자 버튼 표시
                    document.getElementById('btnManage').style.display = 'block';
                    document.getElementById('btnWrite').style.display = 'block';
                }
            } catch (e) {
                console.error("Role parse error", e);
            }
        }
    }

    // 2. 목록 가져오기
    async function getBoardData(){
        let url = "/api/boards";
        const authToken = sessionStorage.getItem('authToken');

        if (!authToken) {
            alert("로그인이 필요합니다.");
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch(url, {
                method: "GET",
                headers: {
                    'X-AUTH-TOKEN': authToken,
                    'Content-Type': 'application/json'
                }
            });

            if (response.status === 401 || response.status === 403) {
                throw new Error("Unauthorized");
            }

            const data = await response.json();

            if(data.result === "login"){ // 서버 로직에 따라 다름
                throw new Error("Session Expired");
            }

            renderTable(data.list || []);
            document.body.style.display = 'block';

        } catch (error) {
            console.error("Fetch Error:", error);
            if(error.message === "Unauthorized" || error.message === "Session Expired") {
                alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                sessionStorage.removeItem('authToken');
                window.location.href = '/login';
            }
        }
    }

    // 3. 테이블 렌더링 (아코디언 구조)
    function renderTable(list) {
        const tbody = document.querySelector("#boardList");
        let html = '';

        if(!list || list.length === 0) {
            html = '<tr><td colspan="4" class="no-data">등록된 게시글이 없습니다.</td></tr>';
        } else {
            list.forEach((item) => {
                // 요약 행 (클릭 시 toggleDetail 실행)
                html += `
                    <tr class="summary-row" onclick="toggleDetail(${item.boardId})">
                        <td>${item.boardId}</td>
                        <td style="font-weight:bold;">${item.title}</td>
                        <td>${item.writer || '익명'}</td>
                        <td>${item.createdAt || '-'}</td>
                    </tr>
                `;

                // 상세 행 (처음엔 숨김, id="detail-번호")
                html += `
                    <tr id="detail-${item.boardId}" class="detail-row">
                        <td colspan="4" class="detail-cell">
                            <div class="detail-content-box" id="content-box-${item.boardId}">
                                <div id="content-${item.boardId}" class="detail-text">
                                    <div style="text-align:center; color:#999; padding:20px;">
                                        Loading details...
                                    </div>
                                </div>
                                <div id="actions-${item.boardId}" class="detail-actions" style="display:none;"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        tbody.innerHTML = html;
    }

    // 4. 상세 내용 토글 (API 호출 포함)
    async function toggleDetail(id) {
        const detailRow = document.getElementById(`detail-${id}`);
        const contentBox = document.getElementById(`content-box-${id}`);
        const contentDiv = document.getElementById(`content-${id}`);
        const actionsDiv = document.getElementById(`actions-${id}`);

        // 열려있으면 닫기
        if (detailRow.style.display === 'table-row') {
            detailRow.style.display = 'none';
            return;
        }

        // 닫혀있으면 열기
        detailRow.style.display = 'table-row';

        // 이미 로드된 데이터가 있으면 API 호출 안 함 (data-loaded 속성 확인)
        if (contentBox.dataset.loaded === "true") {
            return;
        }

        // 서버에서 상세 내용 가져오기
        try {
            const authToken = sessionStorage.getItem('authToken');
            const response = await fetch(`/api/boards/${id}`, {
                method: "GET",
                headers: { 'X-AUTH-TOKEN': authToken }
            });

            if (!response.ok) throw new Error("Load failed");

            const data = await response.json();
            // 가정: 서버 응답이 { result: "success", dto: { ... } } 형태
            const board = data.dto || data;

            // 내용 채우기 (HTML 태그가 있다면 innerHTML, 아니면 innerText)
            contentDiv.innerText = board.content;

            // 본인 글이거나 관리자일 때만 수정/삭제 버튼 표시
            // (board.writerEmail 등 식별자가 있다고 가정, 없다면 isAdmin만 체크)
            if (isAdmin) {
                actionsDiv.style.display = 'block';
                actionsDiv.innerHTML = `
                    <button class="btn-sm btn-edit" onclick="goEdit(${id})">수정</button>
                    <button class="btn-sm btn-delete" onclick="deleteBoard(${id})">삭제</button>
                `;
            }

            // 로드 완료 표시
            contentBox.dataset.loaded = "true";

        } catch (e) {
            console.error(e);
            contentDiv.innerHTML = '<span style="color:red;">내용을 불러오지 못했습니다.</span>';
        }
    }

    // 5. 페이지 이동 및 삭제 로직
    function goEdit(id) {
        location.href = `board_write.html?boardId=${id}`;
    }

    async function deleteBoard(id) {
        if(!confirm("정말 삭제하시겠습니까?")) return;

        const authToken = sessionStorage.getItem('authToken');
        try {
            const response = await fetch(`/api/boards/${id}`, {
                method: 'DELETE',
                headers: { 'X-AUTH-TOKEN': authToken }
            });
            const data = await response.json();

            if (data.result === "success") {
                alert("삭제되었습니다.");
                // 전체 새로고침 대신 해당 행만 지울 수도 있지만, 편의상 목록 새로고침
                getBoardData();
            } else {
                alert("삭제 실패: " + data.message);
            }
        } catch(e) {
            alert("오류가 발생했습니다.");
        }
    }

    async function handleLogout() {
        sessionStorage.clear();
        alert("로그아웃 되었습니다.");
        window.location.href = '/login';
    }
</script>
</body>
</html>