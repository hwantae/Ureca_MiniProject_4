<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ë£¸ ê´€ë¦¬</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #fff0f0; }
        h1 { color: #333; text-align:center; }
        .header { margin-bottom: 20px; text-align:center; }
        .slots { display:flex; flex-wrap:wrap; gap:10px; margin:20px 0; justify-content:center; }
        .slot { padding: 15px 20px; border: 1px solid #ddd; background: #fff; cursor: pointer; text-align:center; min-width:140px; }
        .slot:hover { background:#e0e0e0; }
        .slot.unavailable { border-color: red; background:#fee; opacity:0.85; }
        .slot.available { border-color: green; }
        .legend { margin-top: 20px; font-size: 0.9em; color: #666; text-align:center; }
        .legend span { margin-right: 15px; }
    </style>
</head>

<body>
<div class="header"><a href="admin_rooms.html">â† ê´€ë¦¬ì ëª©ë¡ìœ¼ë¡œ</a></div>
<h1 id="title">ë£¸ ê´€ë¦¬ (ë¸”ë¡ ì„¤ì •)</h1>

<div style="margin:20px 0; text-align:center;">ğŸ“… ë‚ ì§œ: <input type="date" id="date"></div>
<div id="slots" class="slots">ë¡œë”© ì¤‘...</div>

<div class="legend">
    <span>â¬œ ì´ìš© ê°€ëŠ¥ (í´ë¦­í•˜ì—¬ ì°¨ë‹¨)</span>
    <span>ğŸŸ¥ ì°¨ë‹¨ë¨/ì‚¬ìš©ì¤‘ (í´ë¦­í•˜ì—¬ í•´ì œ)</span>
</div>

<script>
    function getToken() {
        return sessionStorage.getItem('authToken');
    }

    const roomName = new URLSearchParams(location.search).get('name') || '';
    if (!roomName) location.href = 'admin_rooms.html';
    document.getElementById('title').textContent = `${roomName} ê´€ë¦¬`;

    const dateInput = document.getElementById('date');
    dateInput.value = new Date().toISOString().split('T')[0];
    dateInput.addEventListener('change', () => loadSlots(dateInput.value));

    let roomId = null;
    let currentBlocks = new Map(); // startHHmm -> blockId
    let slotList = []; // [{slotId, startHHmm, endHHmm}]

    function formatHHmm(t) {
        return (t || "").substring(0, 5);
    }

    async function loadSlots(dateStr) {
        const container = document.getElementById('slots');
        container.innerHTML = "ë¡œë”© ì¤‘...";

        try {
            const token = getToken();
            if (!token) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                location.href = "/login";
                return;
            }

            // 1) í…œí”Œë¦¿ ìŠ¬ë¡¯(ì—¬ëŸ¬ ê°œ) ì¡°íšŒ
            const slotsRes = await fetch(`/api/rooms/name/${encodeURIComponent(roomName)}/slots`, {
                headers: { 'X-AUTH-TOKEN': token }
            });
            const slots = await slotsRes.json();
            if (!slots || slots.length === 0) {
                container.innerHTML = 'ìš´ì˜ ì‹œê°„ ë¯¸ì„¤ì •';
                return;
            }

            // roomIdëŠ” ìŠ¬ë¡¯ì— ë“¤ì–´ìˆë‹¤ê³  ê°€ì •(ë„ˆì˜ ì´ì „ ì½”ë“œë„ ì´ ë°©ì‹)
            roomId = slots[0].roomId;

            slotList = slots.map(s => ({
                slotId: s.slotId,
                startHHmm: formatHHmm(s.startTime),
                endHHmm: formatHHmm(s.endTime)
            })).sort((a, b) => a.startHHmm.localeCompare(b.startHHmm));

            // 2) ë¸”ë¡ ì¡°íšŒ
            const blocksRes = await fetch(`/api/rooms/${roomId}/blocks?date=${dateStr}`, {
                headers: { 'X-AUTH-TOKEN': token }
            });
            const blocks = await blocksRes.json();
            currentBlocks.clear();
            (blocks || []).forEach(b => currentBlocks.set(formatHHmm(b.startTime), b.id));

            // 3) ë Œë”ë§(ìŠ¬ë¡¯ ì „ì²´)
            let html = '';
            slotList.forEach(s => {
                const isBlocked = currentBlocks.has(s.startHHmm);
                const cls = isBlocked ? 'unavailable' : 'available';
                html += `<div class="slot ${cls}" onclick="toggleBlock('${s.startHHmm}', '${s.endHHmm}', ${isBlocked})">
                            ${s.startHHmm} ~ ${s.endHHmm}
                         </div>`;
            });
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = 'ë¡œë“œ ì‹¤íŒ¨';
        }
    }

    async function toggleBlock(startHHmm, endHHmm, isBlocked) {
        const token = getToken();
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/login";
            return;
        }

        if (isBlocked) {
            if (!confirm(`${startHHmm} ë¸”ë¡ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const blockId = currentBlocks.get(startHHmm);

            await fetch(`/api/rooms/${roomId}/blocks/${blockId}`, {
                method: 'DELETE',
                headers: { 'X-AUTH-TOKEN': token }
            });

        } else {
            if (!confirm(`${startHHmm} ~ ${endHHmm} ì„(ë¥¼) ë§‰ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            await fetch(`/api/rooms/${roomId}/blocks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-AUTH-TOKEN': token
                },
                body: JSON.stringify({
                    blockDate: dateInput.value,
                    startTime: startHHmm,
                    endTime: endHHmm
                })
            });
        }

        loadSlots(dateInput.value);
    }

    loadSlots(dateInput.value);
</script>
</body>
</html>
