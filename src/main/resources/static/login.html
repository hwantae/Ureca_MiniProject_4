<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>로그인</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background-color: #f4f6f9;
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100vh;
			margin: 0;
		}
		.container {
			background-color: #ffffff;
			padding: 40px;
			border-radius: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
			width: 100%;
			max-width: 400px;
		}
		h1 {
			text-align: center;
			color: #333;
			margin-bottom: 30px;
			font-size: 24px;
		}
		.form-group {
			margin-bottom: 20px;
		}
		label {
			display: block;
			margin-bottom: 5px;
			color: #666;
			font-weight: 500;
		}
		input {
			width: 100%;
			padding: 12px;
			border: 1px solid #ddd;
			border-radius: 5px;
			box-sizing: border-box;
			transition: border-color 0.3s;
		}
		input:focus {
			outline: none;
			border-color: #5c67f2;
		}
		button {
			width: 100%;
			padding: 12px;
			background-color: #5c67f2;
			color: white;
			border: none;
			border-radius: 5px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			transition: background-color 0.3s;
		}
		button:hover {
			background-color: #4a54c3;
		}
		#errorMessage {
			color: #e74c3c;
			text-align: center;
			margin-top: 15px;
			font-size: 14px;
			min-height: 20px;
		}
		.link {
			text-align: center;
			margin-top: 20px;
			font-size: 14px;
		}
		.link a {
			color: #5c67f2;
			text-decoration: none;
		}
	</style>
</head>
<body>
<div class="container">
	<h1>Welcome Back</h1>

	<div class="form-group">
		<label for="username">Email Address</label>
		<input type="text" id="username" name="username" placeholder="이메일을 입력하세요">
	</div>

	<div class="form-group">
		<label for="password">Password</label>
		<input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요">
	</div>

	<button id="btnLogin">Login</button>

	<div id="errorMessage"></div>

	<div class="link">
		계정이 없으신가요? <a href="/register.html">회원가입</a>
	</div>
</div>

<script>
	window.onload = function(){
		document.querySelector("#btnLogin").onclick = login;

		// 엔터키 로그인 지원
		document.querySelector("#password").addEventListener("keypress", function(event) {
			if (event.key === "Enter") {
				login();
			}
		});
	}

	async function login(){
		let url = "/auth/login";

		let username = document.querySelector("#username").value;
		let password = document.querySelector("#password").value;
		let errorMsg = document.querySelector("#errorMessage");

		errorMsg.innerText = ""; // 기존 에러 메시지 초기화

		if(!username || !password) {
			errorMsg.innerText = "이메일과 비밀번호를 모두 입력해주세요.";
			return;
		}

		let urlParams = new URLSearchParams({
			username, password
		});

		let fetchOptions = {
			method: "post",
			body: urlParams
		}

		try {
			let response = await fetch(url, fetchOptions);
			let data = await response.json();

			console.log(data);

			if( data.result == "success" ){
				sessionStorage.setItem('authToken', data.token);
				// 2. 권한 정보 저장 (구조: data -> userDto -> role)
				// role은 List<String>이므로 ["ROLE_ADMIN"] 같은 배열입니다.
				// sessionStorage에는 문자열만 저장되므로 JSON.stringify로 변환합니다.
				if (data.userDto && data.userDto.role) {
					// 배열(List)을 문자열로 바꿔서 저장해야 함
					sessionStorage.setItem('roles', JSON.stringify(data.userDto.role));

					console.log("권한 저장 완료:", data.userDto.role); // 확인용 로그
				} else {
					console.warn("서버 응답에 권한 정보가 없습니다.");
				}

				// 3. 사용자 이름 저장 (환영 메시지용)
				if (data.userDto && data.userDto.name) {
					sessionStorage.setItem('userName', data.userDto.name);
				}
				alert("로그인 성공!");
				window.location.href = "/board.html";
			} else {
				errorMsg.innerText = "아이디 또는 비밀번호가 올바르지 않습니다.";
			}
		} catch (error) {
			console.error("Login Error:", error);
			errorMsg.innerText = "서버 연결에 실패했습니다.";
		}
	}
</script>
</body>
</html>

