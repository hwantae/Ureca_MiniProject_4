<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyRoom - 게시판</title>
    <style>
        /* --- 디자인 스타일 (이전과 동일) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: none; /* 로딩 전 숨김 */
        }
        nav {
            background-color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .nav-brand {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            text-decoration: none;
        }
        #btnLogout {
            background-color: transparent;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #btnLogout:hover {
            background-color: #e74c3c;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .page-title {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            display: inline-block;
        }
        .board-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        .board-table th, .board-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .board-table th {
            background-color: #f8f9fa;
            color: #555;
            font-weight: 600;
        }
        .board-table tr:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #999;
        }
    </style>
</head>
<body>

<nav>
    <a href="/" class="nav-brand">StudyRoom</a>
    <button id="btnLogout">로그아웃</button>
</nav>

<div class="container">
    <h2 class="page-title">공지사항 및 게시판</h2>
    <table class="board-table">
        <thead>
        <tr>
            <th style="width: 10%;">No</th>
            <th style="width: 50%;">제목</th>
            <th style="width: 20%;">작성자</th>
            <th style="width: 20%;">작성일</th>
        </tr>
        </thead>
        <tbody id="boardList">
        </tbody>
    </table>
</div>
<div class="board-actions">
    <button type="button" class="btn-reservation" onclick="location.href='rooms.html'">
        예약하기
    </button>
    <button type="button" class="btn-manage" onclick="location.href='admin_rooms.html'">
        관리하기
    </button>
</div>

<style>
    .board-actions {
        margin-top: 20px;
        display: flex;          /* 플렉스박스 사용 */
        justify-content: center; /* ★ 여기가 핵심: 요소를 가운데 정렬합니다 ★ */
        gap: 10px;              /* 버튼 사이 간격 */
    }

    .board-actions button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        color: white;
    }

    /* 예약하기 버튼 색상 */
    .btn-reservation {
        background-color: #007bff;
    }
    .btn-reservation:hover {
        background-color: #0056b3;
    }

    /* 관리하기 버튼 색상 */
    .btn-manage {
        background-color: #6c757d;
    }
    .btn-manage:hover {
        background-color: #545b62;
    }
</style>
<script src="/assets/js/common.js"></script>
<script>
    window.onload = function(){
        getBoardData();

        // common.js의 기능과 세션 삭제 기능을 합친 핸들러 연결
        document.querySelector("#btnLogout").onclick = handleLogout;
    }

    async function getBoardData(){
        let url = "/api/boards";
        const authToken = sessionStorage.getItem('authToken');

        // 1. 토큰 유무 확인
        if (!authToken) {
            alert("로그인이 필요합니다.");
            window.location.href = '/login';
            return;
        }

        // 2. csrfFetch 사용 (fetch 대신)
        // common.js가 자동으로 CSRF 헤더를 추가해주지만,
        // JWT(X-AUTH-TOKEN)는 우리가 직접 넣어줘야 함
        let fetchOptions = {
            method: "GET",
            headers: {
                'X-AUTH-TOKEN': authToken
            }
        };

        try {
            // ★ csrfFetch 호출 (common.js 함수)
            let response = await csrfFetch(url, fetchOptions);

            if (response.status === 401 || response.status === 403) {
                throw new Error("Unauthorized");
            }

            let data = await response.json();

            if(data.result === "login"){
                throw new Error("Session Expired");
            }

            // 데이터 렌더링
            renderTable(data.list || []); // 서버 응답 키값에 따라 수정 (data.list 등)

            // 화면 표시
            document.body.style.display = 'block';

        } catch (error) {
            console.error("Fetch Error:", error);
            sessionStorage.removeItem('authToken'); // 에러 시 토큰 삭제
            window.location.href = '/login';
        }
    }

    function renderTable(list) {
        const tbody = document.querySelector("#boardList");
        let html = '';

        if(!list || list.length === 0) {
            html = '<tr><td colspan="4" class="no-data">등록된 게시글이 없습니다.</td></tr>';
        } else {
            list.forEach((item) => {
                html += `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.title}</td>
                        <td>${item.writer || '관리자'}</td>
                        <td>${item.regDate || '-'}</td>
                    </tr>
                `;
            });
        }
        tbody.innerHTML = html;
    }

    // 로그아웃 통합 처리
    async function handleLogout() {
        // 1. 클라이언트 측 토큰 삭제 (JWT)
        sessionStorage.removeItem('authToken');

        // 2. 서버 측 로그아웃 처리 (common.js의 csrfLogout 호출)
        // common.js 안에서 /logout 호출 후 페이지 이동까지 처리되어 있음
        await csrfLogout();
    }
</script>
</body>
</html>